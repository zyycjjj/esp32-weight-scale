#include "app/zh_bitmaps.h"

#include "app/display_st7789.h"

#include <stddef.h>
#include <stdint.h>

namespace aiw {

static uint8_t g_renderMode = 0;

void setZhRenderMode(uint8_t mode) {
  g_renderMode = (uint8_t)(mode & 0x03u);
}

uint8_t zhRenderMode() {
  return g_renderMode;
}

static const uint8_t glyph_sel_0[32] = {
    0x00,0x00, 0x0F,0xF0, 0x08,0x10, 0x0B,0xD0, 0x08,0x10, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0,
    0x01,0x00, 0x01,0x00, 0x01,0x00, 0x3F,0xFC, 0x01,0x00, 0x01,0x00, 0x01,0x00, 0x00,0x00,
};
static const uint8_t glyph_sel_1[32] = {
    0x00,0x00, 0x3F,0xFC, 0x20,0x04, 0x2F,0xF4, 0x20,0x04, 0x2F,0xF4, 0x20,0x04, 0x3F,0xFC,
    0x04,0x40, 0x04,0x40, 0x04,0x40, 0x7F,0xFE, 0x04,0x40, 0x04,0x40, 0x04,0x40, 0x00,0x00,
};
static const uint8_t glyph_sel_2[32] = {
    0x00,0x00, 0x01,0x00, 0x01,0x00, 0x7F,0xFE, 0x01,0x00, 0x0F,0xF0, 0x09,0x90, 0x09,0x90,
    0x0F,0xF0, 0x01,0x00, 0x01,0x00, 0x7F,0xFE, 0x01,0x00, 0x01,0x00, 0x01,0x00, 0x00,0x00,
};
static const uint8_t glyph_sel_3[32] = {
    0x00,0x00, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0,
    0x10,0x08, 0x10,0x08, 0x1F,0xF8, 0x10,0x08, 0x10,0x08, 0x10,0x08, 0x10,0x08, 0x00,0x00,
};
static const uint8_t glyph_qr_0[32] = {
    0x00,0x00, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0, 0x00,0x00, 0x7F,0xFE, 0x40,0x02, 0x4F,0xF2,
    0x48,0x12, 0x4F,0xF2, 0x48,0x12, 0x4F,0xF2, 0x40,0x02, 0x7F,0xFE, 0x00,0x00, 0x00,0x00,
};
static const uint8_t glyph_qr_1[32] = {
    0x00,0x00, 0x3F,0xFC, 0x20,0x04, 0x2F,0xF4, 0x20,0x04, 0x2F,0xF4, 0x20,0x04, 0x3F,0xFC,
    0x08,0x10, 0x08,0x10, 0x0F,0xF0, 0x08,0x10, 0x08,0x10, 0x08,0x10, 0x08,0x10, 0x00,0x00,
};
static const uint8_t glyph_qr_2[32] = {
    0x00,0x00, 0x7F,0xFE, 0x01,0x00, 0x01,0x00, 0x01,0x00, 0x7F,0xFE, 0x01,0x00, 0x01,0x00,
    0x01,0x00, 0x01,0x00, 0x01,0x00, 0x7F,0xFE, 0x01,0x00, 0x01,0x00, 0x01,0x00, 0x00,0x00,
};
static const uint8_t glyph_qr_3[32] = {
    0x00,0x00, 0x7F,0xFE, 0x40,0x02, 0x4F,0xF2, 0x48,0x12, 0x4F,0xF2, 0x48,0x12, 0x4F,0xF2,
    0x40,0x02, 0x7F,0xFE, 0x00,0x00, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0,
};

static const MonoGlyph16 glyphs[] = {
    {0x9009, glyph_sel_0},
    {0x62E9, glyph_sel_1},
    {0x8EAB, glyph_sel_2},
    {0x9AD8, glyph_sel_3},
    {0x626B, glyph_qr_0},
    {0x7801, glyph_qr_1},
    {0x652F, glyph_qr_2},
    {0x4ED8, glyph_qr_3},
};

const MonoGlyph16 *findZhGlyph(uint32_t codepoint) {
  for (size_t i = 0; i < sizeof(glyphs) / sizeof(glyphs[0]); ++i) {
    if (glyphs[i].codepoint == codepoint) return &glyphs[i];
  }
  return nullptr;
}

static bool utf8Next(const char *s, size_t &i, uint32_t &cp) {
  uint8_t c = (uint8_t)s[i];
  if (c == 0) return false;
  if (c < 0x80) {
    cp = c;
    i += 1;
    return true;
  }
  if ((c & 0xE0) == 0xC0) {
    uint8_t c1 = (uint8_t)s[i + 1];
    if ((c1 & 0xC0) != 0x80) return false;
    cp = ((uint32_t)(c & 0x1F) << 6) | (uint32_t)(c1 & 0x3F);
    i += 2;
    return true;
  }
  if ((c & 0xF0) == 0xE0) {
    uint8_t c1 = (uint8_t)s[i + 1];
    uint8_t c2 = (uint8_t)s[i + 2];
    if (((c1 & 0xC0) != 0x80) || ((c2 & 0xC0) != 0x80)) return false;
    cp = ((uint32_t)(c & 0x0F) << 12) | ((uint32_t)(c1 & 0x3F) << 6) | (uint32_t)(c2 & 0x3F);
    i += 3;
    return true;
  }
  return false;
}

static void drawGlyph16(DisplaySt7789 &display, int x, int y, const uint8_t *rows, uint16_t fg, uint16_t bg) {
  for (int r = 0; r < 16; ++r) {
    uint8_t a0 = rows[r * 2 + 0];
    uint8_t a1 = rows[r * 2 + 1];
    uint8_t b0 = (g_renderMode & 0x01u) ? a1 : a0;
    uint8_t b1 = (g_renderMode & 0x01u) ? a0 : a1;
    for (int c = 0; c < 8; ++c) {
      bool on = (g_renderMode & 0x02u) ? ((b0 & (0x01u << c)) != 0) : ((b0 & (0x80u >> c)) != 0);
      display.fillRect(x + c, y + r, 1, 1, on ? fg : bg);
    }
    for (int c = 0; c < 8; ++c) {
      bool on = (g_renderMode & 0x02u) ? ((b1 & (0x01u << c)) != 0) : ((b1 & (0x80u >> c)) != 0);
      display.fillRect(x + 8 + c, y + r, 1, 1, on ? fg : bg);
    }
  }
}

void drawZhText16(DisplaySt7789 &display, int x, int y, const char *utf8, uint16_t fg, uint16_t bg) {
  if (!utf8) return;
  size_t i = 0;
  int cx = x;
  while (true) {
    uint32_t cp = 0;
    if (!utf8Next(utf8, i, cp)) break;
    const MonoGlyph16 *g = findZhGlyph(cp);
    if (g) {
      drawGlyph16(display, cx, y, g->rows, fg, bg);
      cx += 16;
    } else {
      cx += 8;
    }
  }
}

}  // namespace aiw
