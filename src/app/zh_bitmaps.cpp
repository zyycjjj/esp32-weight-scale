#include "app/zh_bitmaps.h"

#include "app/display_st7789.h"
#include "app/zh_font_gb1_28_subset.h"

#include <stddef.h>
#include <stdint.h>

namespace aiw {

static uint8_t g_renderMode = 3;

void setZhRenderMode(uint8_t mode) {
  g_renderMode = (uint8_t)(mode & 0x03u);
}

uint8_t zhRenderMode() {
  return g_renderMode;
}

static const uint8_t glyph_sel_0[32] = {
    0x00,0x00, 0x0F,0xF0, 0x08,0x10, 0x0B,0xD0, 0x08,0x10, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0,
    0x01,0x00, 0x01,0x00, 0x01,0x00, 0x3F,0xFC, 0x01,0x00, 0x01,0x00, 0x01,0x00, 0x00,0x00,
};
static const uint8_t glyph_sel_1[32] = {
    0x00,0x00, 0x3F,0xFC, 0x20,0x04, 0x2F,0xF4, 0x20,0x04, 0x2F,0xF4, 0x20,0x04, 0x3F,0xFC,
    0x04,0x40, 0x04,0x40, 0x04,0x40, 0x7F,0xFE, 0x04,0x40, 0x04,0x40, 0x04,0x40, 0x00,0x00,
};
static const uint8_t glyph_sel_2[32] = {
    0x00,0x00, 0x01,0x00, 0x01,0x00, 0x7F,0xFE, 0x01,0x00, 0x0F,0xF0, 0x09,0x90, 0x09,0x90,
    0x0F,0xF0, 0x01,0x00, 0x01,0x00, 0x7F,0xFE, 0x01,0x00, 0x01,0x00, 0x01,0x00, 0x00,0x00,
};
static const uint8_t glyph_sel_3[32] = {
    0x00,0x00, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0,
    0x10,0x08, 0x10,0x08, 0x1F,0xF8, 0x10,0x08, 0x10,0x08, 0x10,0x08, 0x10,0x08, 0x00,0x00,
};
static const uint8_t glyph_qr_0[32] = {
    0x00,0x00, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0, 0x00,0x00, 0x7F,0xFE, 0x40,0x02, 0x4F,0xF2,
    0x48,0x12, 0x4F,0xF2, 0x48,0x12, 0x4F,0xF2, 0x40,0x02, 0x7F,0xFE, 0x00,0x00, 0x00,0x00,
};
static const uint8_t glyph_qr_1[32] = {
    0x00,0x00, 0x3F,0xFC, 0x20,0x04, 0x2F,0xF4, 0x20,0x04, 0x2F,0xF4, 0x20,0x04, 0x3F,0xFC,
    0x08,0x10, 0x08,0x10, 0x0F,0xF0, 0x08,0x10, 0x08,0x10, 0x08,0x10, 0x08,0x10, 0x00,0x00,
};
static const uint8_t glyph_qr_2[32] = {
    0x00,0x00, 0x7F,0xFE, 0x01,0x00, 0x01,0x00, 0x01,0x00, 0x7F,0xFE, 0x01,0x00, 0x01,0x00,
    0x01,0x00, 0x01,0x00, 0x01,0x00, 0x7F,0xFE, 0x01,0x00, 0x01,0x00, 0x01,0x00, 0x00,0x00,
};
static const uint8_t glyph_qr_3[32] = {
    0x00,0x00, 0x7F,0xFE, 0x40,0x02, 0x4F,0xF2, 0x48,0x12, 0x4F,0xF2, 0x48,0x12, 0x4F,0xF2,
    0x40,0x02, 0x7F,0xFE, 0x00,0x00, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0, 0x08,0x10, 0x0F,0xF0,
};

static const uint8_t glyph_btn_qu[32] = {
    0x01,0x00,0x01,0x00,0x01,0x08,0x7F,0xFC,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x04,
    0xFF,0xFE,0x02,0x00,0x02,0x00,0x04,0x40,0x08,0x20,0x10,0x10,0x3F,0xF8,0x00,0x08,
};
static const uint8_t glyph_btn_pi[32] = {
    0x00,0x80,0x00,0x80,0x00,0x80,0x3F,0xFC,0x20,0x84,0x20,0x88,0x20,0x80,0x2F,0xF8,
    0x20,0x08,0x24,0x10,0x22,0x20,0x21,0x40,0x20,0x80,0x41,0x60,0x46,0x1E,0x98,0x04,
};
static const uint8_t glyph_btn_fan[32] = {
    0x00,0x08,0x40,0x1C,0x33,0xE0,0x12,0x00,0x02,0x00,0x02,0xF8,0xF2,0x08,0x12,0x90,
    0x12,0x50,0x12,0x20,0x12,0x50,0x14,0x8C,0x15,0x04,0x28,0x00,0x44,0x06,0x03,0xFC,
};
static const uint8_t glyph_btn_hui[32] = {
    0x00,0x00,0x00,0x04,0x7F,0xFE,0x40,0x04,0x40,0x44,0x47,0xE4,0x44,0x44,0x44,0x44,
    0x44,0x44,0x44,0x44,0x47,0xC4,0x44,0x44,0x40,0x04,0x7F,0xFC,0x40,0x04,0x00,0x00,
};
static const uint8_t glyph_btn_qu2[32] = {
    0x01,0x00,0xFF,0x80,0x22,0x00,0x23,0xFC,0x3E,0x04,0x22,0x84,0x22,0x88,0x3E,0x88,
    0x22,0x48,0x22,0x50,0x22,0x20,0x3E,0x50,0xE2,0x48,0x42,0x8E,0x03,0x04,0x02,0x00,
};
static const uint8_t glyph_btn_xiao[32] = {
    0x00,0x40,0x42,0x48,0x31,0x50,0x10,0x48,0x83,0xFC,0x62,0x08,0x22,0x08,0x0B,0xF8,
    0x12,0x08,0x22,0x08,0xE3,0xF8,0x22,0x08,0x22,0x08,0x22,0x08,0x22,0x28,0x22,0x10,
};
static const uint8_t glyph_btn_xia[32] = {
    0x00,0x04,0xFF,0xFE,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x80,0x02,0x40,0x02,0x30,
    0x02,0x10,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,0x02,0x00,
};
static const uint8_t glyph_btn_yi[32] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0xFF,0xFE,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};
static const uint8_t glyph_btn_bu[32] = {
    0x01,0x00,0x09,0x00,0x09,0x10,0x09,0xF8,0x09,0x00,0x09,0x04,0xFF,0xFE,0x01,0x00,
    0x09,0x10,0x0D,0x18,0x11,0x20,0x21,0x20,0x00,0xC0,0x03,0x00,0x0C,0x00,0x70,0x00,
};

static const MonoGlyph16 glyphs[] = {
    {0x9009, glyph_sel_0},
    {0x62E9, glyph_sel_1},
    {0x8EAB, glyph_sel_2},
    {0x9AD8, glyph_sel_3},
    {0x626B, glyph_qr_0},
    {0x7801, glyph_qr_1},
    {0x652F, glyph_qr_2},
    {0x4ED8, glyph_qr_3},
    {0x53BB, glyph_btn_qu},
    {0x76AE, glyph_btn_pi},
    {0x8FD4, glyph_btn_fan},
    {0x56DE, glyph_btn_hui},
    {0x53D6, glyph_btn_qu2},
    {0x6D88, glyph_btn_xiao},
    {0x4E0B, glyph_btn_xia},
    {0x4E00, glyph_btn_yi},
    {0x6B65, glyph_btn_bu},
};

const MonoGlyph16 *findZhGlyph(uint32_t codepoint) {
  for (size_t i = 0; i < sizeof(glyphs) / sizeof(glyphs[0]); ++i) {
    if (glyphs[i].codepoint == codepoint) return &glyphs[i];
  }
  return nullptr;
}

static bool utf8Next(const char *s, size_t &i, uint32_t &cp) {
  uint8_t c = (uint8_t)s[i];
  if (c == 0) return false;
  if (c < 0x80) {
    cp = c;
    i += 1;
    return true;
  }
  if ((c & 0xE0) == 0xC0) {
    uint8_t c1 = (uint8_t)s[i + 1];
    if ((c1 & 0xC0) != 0x80) {
      cp = 0xFFFD;
      i += 1;
      return true;
    }
    cp = ((uint32_t)(c & 0x1F) << 6) | (uint32_t)(c1 & 0x3F);
    i += 2;
    return true;
  }
  if ((c & 0xF0) == 0xE0) {
    uint8_t c1 = (uint8_t)s[i + 1];
    uint8_t c2 = (uint8_t)s[i + 2];
    if (((c1 & 0xC0) != 0x80) || ((c2 & 0xC0) != 0x80)) {
      cp = 0xFFFD;
      i += 1;
      return true;
    }
    cp = ((uint32_t)(c & 0x0F) << 12) | ((uint32_t)(c1 & 0x3F) << 6) | (uint32_t)(c2 & 0x3F);
    i += 3;
    return true;
  }
  cp = 0xFFFD;
  i += 1;
  return true;
}

static void drawGlyph16(DisplaySt7789 &display, int x, int y, const uint8_t *rows, uint16_t fg, uint16_t bg) {
  for (int r = 0; r < 16; ++r) {
    uint8_t a0 = rows[r * 2 + 0];
    uint8_t a1 = rows[r * 2 + 1];
    uint8_t b0 = (g_renderMode & 0x01u) ? a1 : a0;
    uint8_t b1 = (g_renderMode & 0x01u) ? a0 : a1;
    for (int c = 0; c < 8; ++c) {
      bool on = (g_renderMode & 0x02u) ? ((b0 & (0x01u << c)) != 0) : ((b0 & (0x80u >> c)) != 0);
      display.fillRect(x + c, y + r, 1, 1, on ? fg : bg);
    }
    for (int c = 0; c < 8; ++c) {
      bool on = (g_renderMode & 0x02u) ? ((b1 & (0x01u << c)) != 0) : ((b1 & (0x80u >> c)) != 0);
      display.fillRect(x + 8 + c, y + r, 1, 1, on ? fg : bg);
    }
  }
}

void drawZhText16(DisplaySt7789 &display, int x, int y, const char *utf8, uint16_t fg, uint16_t bg) {
  if (!utf8) return;
  size_t i = 0;
  int cx = x;
  while (true) {
    uint32_t cp = 0;
    if (!utf8Next(utf8, i, cp)) break;
    const MonoGlyph16 *g = findZhGlyph(cp);
    if (g) {
      drawGlyph16(display, cx, y, g->rows, fg, bg);
      cx += 16;
    } else {
      cx += 8;
    }
  }
}

static void drawGlyph28Bpp4(DisplaySt7789 &display, int x, int y, const ZhGlyph28 &g, uint16_t fg, uint16_t bg) {
  int idx = 0;
  for (int r = 0; r < (int)g.box_h; ++r) {
    for (int c = 0; c < (int)g.box_w; ++c) {
      uint8_t b = g.data[idx / 2];
      uint8_t v = (idx % 2 == 0) ? (uint8_t)((b >> 4) & 0x0Fu) : (uint8_t)(b & 0x0Fu);
      bool on = v >= 4;
      display.fillRect(x + c, y + r, 1, 1, on ? fg : bg);
      idx++;
    }
  }
}

void drawZhText28(DisplaySt7789 &display, int x, int y, const char *utf8, uint16_t fg, uint16_t bg) {
  if (!utf8) return;
  size_t i = 0;
  int cx = x;
  while (true) {
    uint32_t cp = 0;
    if (!utf8Next(utf8, i, cp)) break;
    const ZhGlyph28 *g = findZhGlyph28(cp);
    if (g) {
      drawGlyph28Bpp4(display, cx, y, *g, fg, bg);
    }
    cx += 28;
  }
}

}  // namespace aiw
